<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lunara JSON Library</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Lunara JSON Library</h1>

  <label>
    JSON File:
    <input type="file" id="fileInput" accept=".json">
  </label><br>

  <label>
    Custom Name:
    <input type="text" id="customName" placeholder="MyItem.json">
  </label><br>

  <label>
    Your Author Name:
    <input type="text" id="authorName" placeholder="Evan">
  </label><br>

  <label>
    <input type="checkbox" id="previewable">
    Allow Preview
  </label><br>

  <button onclick="uploadFile()">Upload JSON</button>

  <hr>
  <h2>Public Files</h2>
  <ul id="fileList">Loading...</ul>

  <button onclick="toggleDarkMode()">Toggle Light/Dark Mode</button>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getStorage, ref, uploadBytes, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDlF7iwtlgfBpSwdPePoeFNm-MT0lrhItA",
      authDomain: "lunarajsonstore.firebaseapp.com",
      projectId: "lunarajsonstore",
      storageBucket: "lunarajsonstore.appspot.com",
      messagingSenderId: "321249462989",
      appId: "1:321249462989:web:29ae0ef77166c9a0077784",
      measurementId: "G-FEYVHJZGZQ"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    async function uploadFile() {
      const file = document.getElementById("fileInput").files[0];
      const name = document.getElementById("customName").value.trim();
      const author = document.getElementById("authorName").value.trim();
      const previewable = document.getElementById("previewable").checked;

      if (!file || !name || !author) return alert("Please fill all fields and select a file!");

      const meta = {
        customMetadata: {
          author,
          previewable: previewable.toString()
        }
      };

      const storageRef = ref(storage, 'jsons/' + name);
      await uploadBytes(storageRef, file, meta);
      alert("Uploaded successfully!");
      listFiles();
    }

    async function listFiles() {
      const listRef = ref(storage, 'jsons/');
      const res = await listAll(listRef);
      const fileList = document.getElementById("fileList");
      fileList.innerHTML = "";

      if (res.items.length === 0) {
        fileList.innerHTML = "<li>No files yet.</li>";
        return;
      }

      for (const item of res.items) {
        const url = await getDownloadURL(item);
        const metadata = await item.getMetadata();

        const name = item.name;
        const author = metadata.customMetadata?.author || "Unknown";
        const previewable = metadata.customMetadata?.previewable === "true";

        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${name}</strong> by <em>${author}</em><br>
          <a href="${url}" target="_blank">Download</a>
          ${previewable ? `<button onclick="previewJSON('${url}')">Preview</button>` : ""}
        `;
        fileList.appendChild(li);
      }
    }

    async function previewJSON(url) {
      const res = await fetch(url);
      const json = await res.json();
      alert(JSON.stringify(json, null, 2));
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
    }

    listFiles();
  </script>
</body>
</html>
